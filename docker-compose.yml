services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      SCHEDULE_DB_PATH: /data/schedule.db
      CORS_ALLOW_ORIGINS: https://${DOMAIN}
      # External base URL used to build public iCal subscription links (backend is reachable via /api).
      PUBLIC_BASE_URL: https://${DOMAIN}/api
      ADMIN_USERNAME: ${ADMIN_USERNAME}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRE_MINUTES: ${JWT_EXPIRE_MINUTES}
    volumes:
      - backend_data:/data
    restart: unless-stopped

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        VITE_API_URL: /api
    restart: unless-stopped

  caddy:
    image: caddy:2.8.4
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    environment:
      DOMAIN: ${DOMAIN}
      LETSENCRYPT_EMAIL: ${LETSENCRYPT_EMAIL}
    depends_on:
      - backend
      - frontend
    restart: unless-stopped

volumes:
  backend_data:
  caddy_data:
  caddy_config:
